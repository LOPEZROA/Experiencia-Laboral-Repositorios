{% extends "base.html" %}
{% block content %}

<div class="navline">
  <a class="backlink" href="{{ url_for('home') }}">&larr; Volver al inicio</a>
</div>

<h2 class="h2">Calculo de la Mediana</h2>

<form class="panel" method="post" enctype="multipart/form-data" action="{{ url_for('categoria', slug='vacio') }}">
  <div class="block">
    <label class="label">Cargar archivo de trabajo (.xlsx, .xlsb o .csv)</label>
    <input class="file" type="file" name="workfile" accept=".xlsx,.xlsb,.csv" required>
    <div class="note">Se usan SIGTE_ID, PRESTA_MIN, TIPO_PREST, PRESTA_EST y F_ENTRADA.</div>
  </div>

  <div class="block">
    <div class="label">Parametros por clasificacion (ideal, fecha de corte y fecha P75)</div>
    <div class="checks">
      <label class="check check-mediana">
        <span class="mediana-toggle">
          <input type="checkbox" name="apply_ic" id="apply_ic" {% if apply_input and apply_input.get('IC') %}checked{% endif %}>
          Aplicar
        </span>
        <span class="mediana-cls">IC</span>
        <span class="mediana-field">
          <span>Ideal (dias)</span>
          <input class="file" data-mediana="ic" type="number" name="ideal_ic" min="0" step="1" value="{{ ideales_input.get('IC', '') if ideales_input else '' }}" {% if apply_input and apply_input.get('IC') %}required{% else %}disabled{% endif %}>
        </span>
        <span class="mediana-field">
          <span>Fecha corte</span>
          <input class="file" data-mediana="ic" type="date" name="fecha_corte_ic" value="{{ fecha_corte_input.get('IC', '') if fecha_corte_input else '' }}" {% if apply_input and apply_input.get('IC') %}required{% else %}disabled{% endif %}>
        </span>
        <span class="mediana-field">
          <span>Fecha P75</span>
          <input class="file" data-mediana="ic" type="date" name="fecha_p75_ic" value="{{ fecha_p75_input.get('IC', '') if fecha_p75_input else '' }}" {% if apply_input and apply_input.get('IC') %}required{% else %}disabled{% endif %}>
        </span>
      </label>
      <label class="check check-mediana">
        <span class="mediana-toggle">
          <input type="checkbox" name="apply_dental" id="apply_dental" {% if apply_input and apply_input.get('Dental') %}checked{% endif %}>
          Aplicar
        </span>
        <span class="mediana-cls">Dental</span>
        <span class="mediana-field">
          <span>Ideal (dias)</span>
          <input class="file" data-mediana="dental" type="number" name="ideal_dental" min="0" step="1" value="{{ ideales_input.get('Dental', '') if ideales_input else '' }}" {% if apply_input and apply_input.get('Dental') %}required{% else %}disabled{% endif %}>
        </span>
        <span class="mediana-field">
          <span>Fecha corte</span>
          <input class="file" data-mediana="dental" type="date" name="fecha_corte_dental" value="{{ fecha_corte_input.get('Dental', '') if fecha_corte_input else '' }}" {% if apply_input and apply_input.get('Dental') %}required{% else %}disabled{% endif %}>
        </span>
        <span class="mediana-field">
          <span>Fecha P75</span>
          <input class="file" data-mediana="dental" type="date" name="fecha_p75_dental" value="{{ fecha_p75_input.get('Dental', '') if fecha_p75_input else '' }}" {% if apply_input and apply_input.get('Dental') %}required{% else %}disabled{% endif %}>
        </span>
      </label>
      <label class="check check-mediana">
        <span class="mediana-toggle">
          <input type="checkbox" name="apply_iq" id="apply_iq" {% if apply_input and apply_input.get('IQ') %}checked{% endif %}>
          Aplicar
        </span>
        <span class="mediana-cls">IQ</span>
        <span class="mediana-field">
          <span>Ideal (dias)</span>
          <input class="file" data-mediana="iq" type="number" name="ideal_iq" min="0" step="1" value="{{ ideales_input.get('IQ', '') if ideales_input else '' }}" {% if apply_input and apply_input.get('IQ') %}required{% else %}disabled{% endif %}>
        </span>
        <span class="mediana-field">
          <span>Fecha corte</span>
          <input class="file" data-mediana="iq" type="date" name="fecha_corte_iq" value="{{ fecha_corte_input.get('IQ', '') if fecha_corte_input else '' }}" {% if apply_input and apply_input.get('IQ') %}required{% else %}disabled{% endif %}>
        </span>
        <span class="mediana-field">
          <span>Fecha P75</span>
          <input class="file" data-mediana="iq" type="date" name="fecha_p75_iq" value="{{ fecha_p75_input.get('IQ', '') if fecha_p75_input else '' }}" {% if apply_input and apply_input.get('IQ') %}required{% else %}disabled{% endif %}>
        </span>
      </label>
      <label class="check check-mediana">
        <span class="mediana-toggle">
          <input type="checkbox" name="apply_proc" id="apply_proc" {% if apply_input and apply_input.get('PROC') %}checked{% endif %}>
          Aplicar
        </span>
        <span class="mediana-cls">PROC</span>
        <span class="mediana-field">
          <span>Ideal (dias)</span>
          <input class="file" data-mediana="proc" type="number" name="ideal_proc" min="0" step="1" value="{{ ideales_input.get('PROC', '') if ideales_input else '' }}" {% if apply_input and apply_input.get('PROC') %}required{% else %}disabled{% endif %}>
        </span>
        <span class="mediana-field">
          <span>Fecha corte</span>
          <input class="file" data-mediana="proc" type="date" name="fecha_corte_proc" value="{{ fecha_corte_input.get('PROC', '') if fecha_corte_input else '' }}" {% if apply_input and apply_input.get('PROC') %}required{% else %}disabled{% endif %}>
        </span>
        <span class="mediana-field">
          <span>Fecha P75</span>
          <input class="file" data-mediana="proc" type="date" name="fecha_p75_proc" value="{{ fecha_p75_input.get('PROC', '') if fecha_p75_input else '' }}" {% if apply_input and apply_input.get('PROC') %}required{% else %}disabled{% endif %}>
        </span>
      </label>
    </div>
  </div>

  <button class="btn" type="submit">Calcular mediana</button>
</form>

{% if stats %}
  <div class="panel">
    <div class="block">
      <div><b>Tiempo de ejecucion:</b> {{ elapsed_display }}</div>
      <div><b>Fechas de corte:</b> IC {{ stats.fechas_corte.get('IC', '-') }} | Dental {{ stats.fechas_corte.get('Dental', '-') }} | IQ {{ stats.fechas_corte.get('IQ', '-') }} | PROC {{ stats.fechas_corte.get('PROC', '-') }}</div>
      <div><b>Fechas P75:</b> IC {{ stats.fechas_p75.get('IC', '-') }} | Dental {{ stats.fechas_p75.get('Dental', '-') }} | IQ {{ stats.fechas_p75.get('IQ', '-') }} | PROC {{ stats.fechas_p75.get('PROC', '-') }}</div>
      <div><b>Registros de entrada:</b> {{ stats.total_input }}</div>
      <div><b>Con SIGTE_ID:</b> {{ stats.with_sigte }}</div>
      <div><b>Clasificados (IC, Dental, IQ, PROC):</b> {{ stats.classified }}</div>
      <div><b>Excluidos:</b> {{ stats.excluded }}</div>
    </div>

    {% if out_file %}
      <div class="block">
        <a class="btn" href="{{ url_for('download', filename=out_file) }}">Descargar Excel de medianas</a>
        <a class="btn" href="{{ url_for('categoria', slug='vacio') }}">Repetir operacion con otro archivo</a>
      </div>
    {% else %}
      <div class="block">
        <a class="btn" href="{{ url_for('categoria', slug='vacio') }}">Repetir operacion con otro archivo</a>
      </div>
    {% endif %}

    <div class="block">
      <div class="label">Velocimetros de medianas generales</div>
      <div class="gauge-grid">
        {% for cls in stats.class_order %}
          {% set general = stats.class_tables.get(cls, {}).get('general') %}
          <div class="gauge-card">
            <div class="gauge-title">{{ cls }}</div>
            <canvas id="gauge-{{ loop.index0 }}" class="gauge-canvas" width="280" height="180"></canvas>
            <div class="note">
              Mediana: {{ general.Mediana if general else 0 }} dias |
              Ideal: {{ general.Ideal if general else 0 }} dias
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    {% for cls in stats.class_order %}
      {% set cls_table = stats.class_tables.get(cls, {}) %}
      {% set by_year = cls_table.get('by_year', []) %}
      {% set general = cls_table.get('general') %}

      <div class="block">
        <div class="label">{{ cls }} - Tabla 1: Contador de casos por anio</div>
        <div class="table-scroll">
          <table class="table table-head-1">
            <thead>
              <tr>
                <th>Año</th>
                <th>Casos</th>
                <th>Fallecidos</th>
              </tr>
            </thead>
            <tbody>
              {% if by_year and by_year|length > 0 %}
                {% for row in by_year %}
                  <tr>
                    <td>{{ row.Anio }}</td>
                    <td>{{ row.Casos }}</td>
                    <td>{{ row.Fallecidos }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="3">Sin registros para esta clasificacion.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="block">
        <div class="label">{{ cls }} - Tabla 2: Contador general de casos</div>
        <div class="table-scroll">
          <table class="table table-head-2">
            <thead>
              <tr>
                <th>Casos</th>
                <th>Fallecidos</th>
                <th>Mediana</th>
                <th>Ideal</th>
                <th>Diferencia</th>
                <th>Fecha corte</th>
                <th>Fecha P75</th>
                <th>Casos <= P75</th>
              </tr>
            </thead>
            <tbody>
              {% if general %}
                <tr>
                  <td>{{ general.Casos }}</td>
                  <td>{{ general.Fallecidos }}</td>
                  <td>{{ general.Mediana }}</td>
                  <td>{{ general.Ideal }}</td>
                  <td>{{ general.Diferencia }}</td>
                  <td>{{ general.Fecha_corte }}</td>
                  <td>{{ general.Fecha_p75 }}</td>
                  <td>{{ general.Casos_P75 }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="8">Sin resumen general.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<script>
  (function () {
    const keys = ["ic", "dental", "iq", "proc"];
    function syncRow(key) {
      const check = document.getElementById(`apply_${key}`);
      if (!check) return;
      const on = !!check.checked;
      document.querySelectorAll(`[data-mediana="${key}"]`).forEach((el) => {
        el.disabled = !on;
        el.required = on;
        const field = el.closest(".mediana-field");
        if (field) field.classList.toggle("is-disabled", !on);
      });
    }
    keys.forEach((key) => {
      const check = document.getElementById(`apply_${key}`);
      if (!check) return;
      check.addEventListener("change", () => syncRow(key));
      syncRow(key);
    });
  })();
</script>

{% if stats %}
<script>
  function drawGauge(canvasId, mediana, ideal) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth || 280;
    const cssH = canvas.clientHeight || 180;
    canvas.width = Math.max(1, Math.round(cssW * dpr));
    canvas.height = Math.max(1, Math.round(cssH * dpr));
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    const w = cssW;
    const h = cssH;
    const cx = w / 2;
    const cy = h - 22;
    const r = Math.min(w * 0.40, h * 0.80);
    const med = Math.max(0, Number(mediana || 0));
    const idl = Math.max(0, Number(ideal || 0));
    const warning = idl + 50;
    const maxV = Math.max(1, warning, med, idl) * 1.12;

    ctx.clearRect(0, 0, w, h);
    ctx.lineCap = "round";
    const deg = (d) => d * Math.PI / 180;
    const toAngle = (value) => deg(180 + (Math.max(0, Math.min(value, maxV)) / maxV) * 180);
    const drawArcValue = (v0, v1, color, width) => {
      if (v1 <= v0) return;
      ctx.beginPath();
      ctx.arc(cx, cy, r, toAngle(v0), toAngle(v1), false);
      ctx.strokeStyle = color;
      ctx.lineWidth = width;
      ctx.stroke();
    };

    // Zonas dinamicas por clasificacion:
    // verde <= ideal, amarillo <= ideal+50, rojo > ideal+50.
    const greenEnd = Math.min(idl, maxV);
    const yellowEnd = Math.min(warning, maxV);
    drawArcValue(0, greenEnd, "#16a34a", 14);
    drawArcValue(greenEnd, yellowEnd, "#d97706", 14);
    drawArcValue(yellowEnd, maxV, "#dc2626", 14);

    const ticks = 5;
    for (let i = 0; i <= ticks; i++) {
      const ratio = i / ticks;
      const ang = deg(180 + ratio * 180);
      const x1 = cx + Math.cos(ang) * (r - 2);
      const y1 = cy + Math.sin(ang) * (r - 2);
      const x2 = cx + Math.cos(ang) * (r + 8);
      const y2 = cy + Math.sin(ang) * (r + 8);
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = "#6b7280";
      ctx.lineWidth = 1;
      ctx.stroke();

      const tx = cx + Math.cos(ang) * (r + 20);
      const ty = cy + Math.sin(ang) * (r + 20);
      const tickVal = Math.round(maxV * ratio);
      ctx.fillStyle = "#374151";
      ctx.font = "11px Segoe UI, Arial, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(String(tickVal), tx, ty);
    }

    // Marcador de ideal en el aro (sin manecilla desde el centro).
    const idealAng = toAngle(idl);
    const ix1 = cx + Math.cos(idealAng) * (r - 10);
    const iy1 = cy + Math.sin(idealAng) * (r - 10);
    const ix2 = cx + Math.cos(idealAng) * (r + 10);
    const iy2 = cy + Math.sin(idealAng) * (r + 10);
    ctx.beginPath();
    ctx.moveTo(ix1, iy1);
    ctx.lineTo(ix2, iy2);
    ctx.strokeStyle = "#7c3aed";
    ctx.lineWidth = 3;
    ctx.stroke();
    const ilx = cx + Math.cos(idealAng) * (r + 24);
    const ily = cy + Math.sin(idealAng) * (r + 24);
    ctx.fillStyle = "#7c3aed";
    ctx.font = "11px Segoe UI, Arial, sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("Ideal", ilx, ily);

    const medAng = toAngle(med);
    const mx = cx + Math.cos(medAng) * (r - 12);
    const my = cy + Math.sin(medAng) * (r - 12);
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(mx, my);
    ctx.strokeStyle = "#1d4ed8";
    ctx.lineWidth = 4;
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(cx, cy, 6, 0, 2 * Math.PI);
    ctx.fillStyle = "#111827";
    ctx.fill();

    ctx.fillStyle = "#1d4ed8";
    ctx.fillRect(12, 12, 12, 8);
    ctx.fillStyle = "#111827";
    ctx.font = "12px Segoe UI, Arial, sans-serif";
    ctx.textAlign = "left";
    ctx.fillText("Mediana", 30, 18);
    ctx.textAlign = "center";
    ctx.font = "bold 16px Segoe UI, Arial, sans-serif";
    ctx.fillText(String(Math.round(med)), cx, cy - 22);
    ctx.font = "11px Segoe UI, Arial, sans-serif";
    ctx.fillText("dias", cx, cy - 8);
  }

  const gaugeRows = [
    {% for cls in stats.class_order %}
      {% set general = stats.class_tables.get(cls, {}).get('general') %}
      {
        id: "gauge-{{ loop.index0 }}",
        mediana: {{ (general.Mediana if general and general.Mediana is not none else 0) | tojson }},
        ideal: {{ (general.Ideal if general and general.Ideal is not none else 0) | tojson }}
      }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  function renderGauges() {
    gaugeRows.forEach((item) => drawGauge(item.id, item.mediana, item.ideal));
  }
  renderGauges();
  let gaugeResizeTimer = null;
  window.addEventListener("resize", () => {
    clearTimeout(gaugeResizeTimer);
    gaugeResizeTimer = setTimeout(renderGauges, 120);
  });
</script>
{% endif %}

{% endblock %}
